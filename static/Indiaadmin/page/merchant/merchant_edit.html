<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=318"/>

    <!-- js部分 -->
    <script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
    <script type="text/javascript" src="../../assets/js/common.js?v=318"></script>

    <script type="text/javascript" src="../../assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="../../assets/js/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="../../assets/js/config.url.js"></script>

</head>
<body class="childrenBody">
<form class="layui-form"  >
    <div class="layui-fluid" style="padding-bottom: 400px  ">
        <div class="layui-card">
            <div class="layui-card-header">通道配置</div>
            <div class="layui-card-body">
                <div class="layui-form-item layui-row">
                    <div class="layui-inline layui-col-md5">
                        <label class="layui-form-label">代收通道</label>
                        <div class="layui-input-block">
                            <div id="pay_select" class="xm-select-demo"></div>
                        </div>
                    </div>

                    <div class="layui-inline layui-col-md5">
                        <label class="layui-form-label">代付通道</label>
                        <div class="layui-input-block">
                            <div id="paying_select" class="xm-select-demo"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-card">
            <div class="layui-card-header">基本配置</div>
            <div class="layui-card-body">
                <div class="layui-form-item layui-row">
                    <div class="layui-inline layui-col-md3">
                        <label class="layui-form-label">商户号</label>
                        <div class="layui-input-block">
<!--                            <input type="text" class="layui-input " id="merchant" placeholder="请在此输入商户号">-->
                            <div class="layui-form-mid layui-word-aux" id="merchant"></div>
                        </div>
                    </div>

                    <div class="layui-inline layui-col-md3">
                        <label class="layui-form-label">登录密码</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input " id="login_password" placeholder="请在此输入登录密码">
                        </div>
                    </div>

                    <div class="layui-inline layui-col-md3">
                        <label class="layui-form-label">IP白名单</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input " id="ips" placeholder="请在此输入IP白名单">
                        </div>
                    </div>

                    <div class="layui-inline layui-col-md3">
                        <label class="layui-form-label">最小金额</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input " id="min_money" placeholder="请在此输入最小金额">
                        </div>
                    </div>

                    <div class="layui-inline layui-col-md3">
                        <label class="layui-form-label">最大金额</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input " id="max_money" placeholder="请在此输入最大金额">
                        </div>
                    </div>

                    <div class="layui-inline layui-col-md3">
                        <label class="layui-form-label">提现手续费</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input " id="withdraw_commission" placeholder="请在此输入提现手续费">
                        </div>
                    </div>

<!--                    <div class="layui-inline layui-col-md3">-->
<!--                        <label class="layui-form-label">代收手续费</label>-->
<!--                        <div class="layui-input-block">-->
<!--                            <input type="text" class="layui-input " id="collection_commission" placeholder="请在此输入代收手续费">-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    <div class="layui-inline layui-col-md3">-->
<!--                        <label class="layui-form-label">代付手续费</label>-->
<!--                        <div class="layui-input-block">-->
<!--                            <input type="text" class="layui-input " id="pay_commission" placeholder="请在此输入代付手续费">-->
<!--                        </div>-->
<!--                    </div>-->

                    <div class="layui-inline layui-col-md5">
                        <label class="layui-form-label">谷歌code</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" id="google_code" placeholder="谷歌code">
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="layui-card">
            <div class="layui-card-header">扩展配置</div>
            <div class="layui-card-body">

                <div class="layui-form-item layui-row">
                    <div class="layui-inline layui-col-md8">
                        <label class="layui-form-label ">网关地址</label>
<!--                        <div class="layui-input-block">-->
<!--                            <input name="gateway" id="gateway" placeholder="请输入网关" class="layui-input"/>-->
<!--                        </div>-->

                        <div class="layui-inline" style="width: 620px">
                            <select id="gateway" name="gateway">
                            </select>
                        </div>

                    </div>

                    <div class="layui-inline layui-col-md4">
                        <label class="layui-form-label ">最小代付</label>
                        <div class="layui-input-block">
                            <input name="min_pay" id="min_pay" placeholder="请输入最小代付" class="layui-input"/>
                        </div>
                    </div>

                    <div class="layui-inline layui-col-md4">
                        <label class="layui-form-label ">最大代付</label>
                        <div class="layui-input-block">
                            <input name="max_pay" id="max_pay" placeholder="请输入最大代付" class="layui-input"/>
                        </div>
                    </div>



                    <div class="layui-inline layui-col-md4">
                        <label class="layui-form-label ">谷歌开关:</label>
                        <div class="layui-input-block">
                            <input type="checkbox"  name="google_switch" lay-skin="switch"lay-filter="google_switch_filter" id="google_switch" lay-text="开启|关闭" checked>
                        </div>
                    </div>

                </div>
            </div>
        </div>


        <div class="form-group-bottom text-right" style="margin-bottom: 20px">
            <button class="layui-btn layui-btn-lg" lay-filter="comfireEdit" id="comfireEdit">确认编辑</button>
            <button class="layui-btn layui-btn-lg layui-btn-primary" lay-filter="cancelAdd" id="cancelAdd">取消</button>
        </div>
    </div>

</form>


<script>

    var mybck = $.cookie('tokenMyb');
    if (mybck == "" || mybck == null) {
        window.top.location.href = "../../login.html";
    } else {
        var currParentDatas = eval('(' + parent.jsondata + ')')
        console.log(currParentDatas)
        $("#merchant").text(currParentDatas.MerchantNum)
        $("#ips").val(currParentDatas.WhiteIps)
        $("#login_password").val()
        $("#min_money").val(currParentDatas.MinMoney)
        $("#max_money").val(currParentDatas.MaxMoney)


        $("#min_pay").val(currParentDatas.MinPay)
        $("#max_pay").val(currParentDatas.MaxPay)
        $("#withdraw_commission").val(currParentDatas.WithdrawCommission)
        $("#google_code").val(currParentDatas.GoogleCode)

        // $("#collection_commission").val(currParentDatas.CollectionCommission)
        // $("#pay_commission").val(currParentDatas.PayCommission)


        var payChannelParant =  currParentDatas.PayChannel
        payChannelParant = payChannelParant.split('@')
        // console.log("payChannelParant",payChannelParant);
        // var payChannelParantArray  =  eval('(' + payChannelParant.split('@') + ')');
        var paidChannelParant =   currParentDatas.PaidChannel
        paidChannelParant = paidChannelParant.split('@')
        // console.log("paidChannelParant",paidChannelParant);

        var payChannelArrS = []
        var payingChannelArrS = []
        var CC

        layui.use(['layer', 'form', 'table', 'util', 'admin', 'xmSelect', 'notice'], function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            // var layer = parent.layer === undefined ? layui.layer : top.layer;
            var form = layui.form;
            var table = layui.table;
            var util = layui.util;
            var admin = layui.admin;
            var xmSelect = layui.xmSelect;
            var notice = layui.notice;

            if(currParentDatas.GoogleSwitch === 2){
                $("#google_switch").attr("value", '2');
                $("#google_switch").removeAttr('checked')
            }else {
                $("#google_switch").attr("value", '1');
                $('#google_switch').attr('checked', 'checked'); //改变开关为 开
            }

            //重要,switch attr 之后需要重新渲染checkbox，否则没有效果
            form.render('checkbox');

            var paySel = xmSelect.render({
                el: '#pay_select',
                tips: '请选择代收通道?',
                searchTips: '请选择代收通道?',
                empty: '呀, 没有数据呢',
                // toolbar: {show: true},
                autoRow: true,
                theme: {
                    color: '#fa709a',
                },
                data: []
            })

            var payingSel = xmSelect.render({
                el: '#paying_select',
                tips: '请选择代付通道?',
                searchTips: '请选择代付通道?',
                empty: '呀, 没有数据呢',
                // toolbar: {show: true},
                autoRow: true,
                theme: {
                    color: '#6739b6',
                },
                data: []
            })

            //获取数据添加到下拉框中
            var param = {};
            param.page = 1
            param.limit = 3000

            //通道
            $.ajax({
                url: global_requestAddress + global_requestAddress_js_channel + "?action=check",
                headers: {
                    "token": mybck
                },
                dataType: 'json',
                type: 'post',
                data: param,
                success: function (res) {
                    if (res.code === 200) {
                        var returnDataArray = res.result

                        returnDataArray.forEach((item,index)=>{
                            if(item.Kinds === 2){ //2代付
                                payChannelArrS.push({
                                    name:"通道名:"+item.ChannelName,
                                    value:item.ID
                                })
                            }else if(item.Kinds === 1){ //代收
                                payingChannelArrS.push({
                                    name:"通道名:"+item.ChannelName,
                                    value:item.ID
                                })
                            }
                        })

                        paySel.update({
                            data: payingChannelArrS,
                            filterable: true,
                            autoRow: true,
                            // // 搜索回调函数
                            // filterMethod: function(val, item, index, prop){
                            //     console.log("item",item)
                            //     console.log("val",val)
                            //     if(val == item.value){//把value相同的搜索出来
                            //         return true;
                            //     }
                            //     if(item.name.indexOf(val) != -1 ){//名称中包含的搜索出来
                            //         return true;
                            //     }
                            //     return false;//不知道的就不管了
                            // },
                        })

                        paySel.setValue(payChannelParant)



                        payingSel.update({
                            autoRow: true,
                            filterable: true,
                            // filterMethod: function(val, item, index, prop){
                            //     if(val == item.value){//把value相同的搜索出来
                            //         return true;
                            //     }
                            //     console.log("111",item.name)
                            //     if(item.name.indexOf(val) != -1){//名称中包含的搜索出来
                            //         return true;
                            //     }
                            //     return false;//不知道的就不管了
                            // },
                            data: payChannelArrS,
                        })
                        payingSel.setValue(paidChannelParant)

                    }
                }
            })

            //下拉选项赋值(网关地址)
            $.ajax({
                //动态获取下拉选项的接口，返回数据主要是id+name
                url: global_requestAddress+global_requestAddress_js_gatewayOperation+"?action=check",
                dataType: 'json',
                type: 'POST',
                headers: {
                    "token": mybck
                },
                data:param,
                success: function (data) {

                    // var returnDataArray = data.result
                    // $("#gateway").empty();
                    // $('#gateway').append(new Option('选择网关地址', ''));// 下拉菜单里添加元素
                    // $.each(returnDataArray, function (index, item) {
                    //     $('#gateway').append(new Option(item.Name, item.ID));// 下拉菜单里添加元素
                    // });
                    //
                    // //利用val值来设置的时候
                    // $("#gateway").val(currParentDatas.GatewayId)
                    // //利用标题来设置的时候
                    // // $('#vip_filter').find('option:contains(' + currParentDatas.VipId + ')').prop('selected',true);
                    // //重新渲染 固定写法
                    // form.render("select");



                    let str="<option value=''>选择网关地址</option>";
                    for(let i of data.result){
                        //组装数据
                        str+=`<option value='${i.ID}'>${i.Name}</option>`;
                    }
                    //jquery赋值方式
                    $("#gateway").html(str);

                    // $('#gateway').children('option[value="'+ currParentDatas.GatewayId  +'"]').attr('selected','');
                    $("#gateway").val(currParentDatas.GatewayId)

                    //重新渲染生效
                    form.render();
                }
            });

            //确认按钮点击事件(这个功能已经实现,但是不知道是否接口问题,暂时修改无效)
            $("#comfireEdit").click(function () {

                // if(!$("#merchant").val()){
                //
                //     layer.msg("商户号不允许为空!", {icon: 2});
                //     return false
                // }

                // if(!$("#login_password").val()){
                //
                //     layer.msg("登录密码不允许为空!", {icon: 2});
                //     return false
                // }

                if(!$("#min_money").val()){

                    layer.msg("最小金额不允许为空!", {icon: 2});
                    return false
                }

                if(!$("#max_money").val()){

                    layer.msg("最大金额不允许为空!", {icon: 2});
                    return false
                }

                var param = {};



                param['id'] = currParentDatas.ID;
                // param['kinds'] = 2;

                if ($('#login_password').val()){
                    param['login_password'] = $('#login_password').val();//登录密码
                }
                if ($('#min_money').val()){
                    param['min_money'] =$('#min_money').val();//最小金额
                }
                if ($('#max_money').val()){
                    param['max_money'] = $('#max_money').val();//最大金额
                }
                if ($('#ips').val()){
                    param['ips'] = $('#ips').val();//IP白名单
                }

                if ($('#gateway').val()){
                    param['gateway_id'] = $('#gateway').val();//网关地址
                }

                if ($('#min_pay').val()){
                    param['min_pay'] = $('#min_pay').val();//最小代付
                }

                if ($('#max_pay').val()){
                    param['max_pay'] = $('#max_pay').val();//最大代付
                }

                if ($('#google_switch').val()){
                    param['google_switch'] = $('#google_switch').val();//谷歌开关
                }

                if ($('#withdraw_commission').val()){
                    param['withdraw_commission'] = $('#withdraw_commission').val();//提现手续费
                }

                // if ($('#collection_commission').val()){
                //     param['collection_commission'] = $('#collection_commission').val();//代收手续费
                // }

                // if ($('#pay_commission').val()){
                //     param['pay_commission'] = $('#pay_commission').val();//代付手续费
                // }


                var google_code=$('#google_code').val();
                if (google_code){
                    param['google_code'] = google_code;
                }


                var pay_selectArr = paySel.getValue("name");
                var pay_selectArrValue = paySel.getValue("value");
                var paying_selectArr = payingSel.getValue("name");
                var paying_selectArrValue = payingSel.getValue("value");
                // console.log(pay_selectArr,pay_selectArrValue)
                // console.log(paying_selectArr,paying_selectArrValue)
                var pay_selectStr = ""
                var paying_selectStr = ""
                pay_selectArrValue.forEach((item,index)=>{
                    pay_selectStr = pay_selectStr + item +"@"
                })
                pay_selectStr = pay_selectStr.substring(0,pay_selectStr.length-1)

                paying_selectArrValue.forEach((item,index)=>{
                    paying_selectStr = paying_selectStr + item +"@"
                })
                paying_selectStr =  paying_selectStr.substring(0,paying_selectStr.length-1)

                if(pay_selectStr){
                    param['pay_channel'] = pay_selectStr
                }else{
                    param['pay_channel'] = ""
                }

                if(paying_selectStr){
                    param['paid_channel'] = paying_selectStr
                }else{
                    param['paid_channel'] = ""
                }



                $.ajax({
                    url: global_requestAddress + global_requestAddress_js_merchant + "?action=update",
                    headers: {
                        "token": mybck,
                    },
                    data: param,
                    type: "POST",
                    dataType: "json",
                    success: function (addResult) {

                        if (addResult.code === 200) {
                            // layer.msg(addResult.msg);
                            notice.msg(addResult.msg, {icon: 1});
                            setTimeout(function () {
                                var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                                parent.layer.close(index);
                                // window.parent.location.reload();
                            }, 1300)

                        } else {
                            notice.msg(addResult.msg, {icon: 2});
                        }

                    },
                });
                // parent.local.reload();
                return false;
            })


            //添加内容点击事件
            $("#cancelAdd").click(function () {

                // layer.msg("取消操作");
                notice.msg('取消操作!', {icon: 5});
                var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                parent.layer.close(index);
                // window.parent.location.reload();

                return false;

            })

            //监听谷歌验证开关
            form.on('switch(google_switch_filter)', function(data){
                if(data.elem.checked){
                    $("#google_switch").attr("value", '1');
                    // console.log(data.value);
                }else{
                    $("#google_switch").attr("value", '2');
                }
            })
        })
    }
</script>
</body>
</html>
