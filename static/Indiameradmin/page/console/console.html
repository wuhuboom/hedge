<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>控制台</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=318"/>
    <script src="../../assets/js/moment.js"></script>
    <script src="../../assets/js/echarts-tooltip-carousel.js"></script>

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        /** 统计快捷方式样式 */
        .console-link-block {
            font-size: 16px;
            padding: 20px 20px;
            border-radius: 4px;
            background-color: #40D4B0;
            color: #FFFFFF !important;
            box-shadow: 0 2px 3px rgba(0, 0, 0, .05);
            position: relative;
            overflow: hidden;
            display: block;
        }

        .console-link-block .console-link-block-num {
            font-size: 40px;
            margin-bottom: 5px;
            opacity: .9;
        }

        .console-link-block .console-link-block-text {
            opacity: .8;
        }

        .console-link-block .console-link-block-icon {
            position: absolute;
            top: 50%;
            right: 20px;
            width: 50px;
            height: 50px;
            font-size: 50px;
            line-height: 50px;
            margin-top: -25px;
            color: #FFFFFF;
            opacity: .8;
        }

        .console-link-block .console-link-block-band {
            color: #fff;
            width: 100px;
            font-size: 12px;
            padding: 2px 0 3px 0;
            background-color: #E32A16;
            line-height: inherit;
            text-align: center;
            position: absolute;
            top: 8px;
            right: -30px;
            transform-origin: center;
            transform: rotate(45deg) scale(.8);
            opacity: .95;
            z-index: 2;
        }

        /** //统计快捷方式样式 */

        /** 设置每个快捷块的颜色 */
        .layui-row > div:nth-child(2) .console-link-block {
            background-color: #55A5EA;
        }

        .layui-row > div:nth-child(3) .console-link-block {
            background-color: #9DAFFF;
        }

        .layui-row > div:nth-child(4) .console-link-block {
            background-color: #F591A2;
        }

        .layui-row > div:nth-child(5) .console-link-block {
            background-color: #FEAA4F;
        }

        .layui-row > div:last-child .console-link-block {
            background-color: #9BC539;
        }

        .console-link-block .console-link-block-num {
            font-size: 20px !important;
        }


    </style>
</head>
<body>
<!-- 正文开始 -->
<div class="layui-fluid ew-console-wrapper">
    <!-- 快捷方式 -->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="AllAmount">0</div>
                <div class="console-link-block-text">总金额</div>
                <i class="console-link-block-icon layui-icon layui-icon-log"></i>
            </div>
        </div>
        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="AvailableAmount">0</div>
                <div class="console-link-block-text">可用余额</div>
                <i class="console-link-block-icon layui-icon layui-icon-user"></i>
            </div>
        </div>
        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="FreezeAmount">0</div>
                <div class="console-link-block-text">冻结金额</div>
                <i class="console-link-block-icon layui-icon layui-icon-username"
                   style="font-size: 62px;padding-right: 5px;"></i>
            </div>
        </div>
        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="TodayCollection">0</div>
                <div class="console-link-block-text">今日代收笔数</div>
                <i class="console-link-block-icon layui-icon layui-icon-face-smile-b"></i>
            </div>
        </div>

        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="TodayCollectionAmount">0</div>
                <div class="console-link-block-text">今日代收金额</div>
                <i class="console-link-block-icon layui-icon layui-icon-dollar"></i>
            </div>
        </div>
        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="TodayCollectionCommission">0</div>
                <div class="console-link-block-text">今日代收手续费</div>
                <i class="console-link-block-icon layui-icon layui-icon-diamond"></i>
            </div>
        </div>

        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="TodayPay">0</div>
                <div class="console-link-block-text">今日代付笔数</div>
                <i class="console-link-block-icon layui-icon layui-icon-diamond"></i>
            </div>
        </div>

        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="TodayPayCommission">0</div>
                <div class="console-link-block-text">今日代付金额</div>
                <i class="console-link-block-icon layui-icon layui-icon-diamond"></i>
            </div>
        </div>

        <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
            <div class="console-link-block">
                <div class="console-link-block-num" id="TodayPayAmount">0</div>
                <div class="console-link-block-text">今日代付手续费</div>
                <i class="console-link-block-icon layui-icon layui-icon-diamond"></i>
            </div>
        </div>


    </div>

    <div class="layui-row layui-col-space15">
        <div class="layui-col-xs12">
            <div class="layui-card" style="overflow: hidden;">
                <div class="layui-card-header">每日数据</div>
                <div class="layui-card-body">


                    <!-- 表格工具栏 -->
                    <form class="layui-form toolbar">
                        <div class="layui-form-item">

                                                <div class="layui-inline">
                                                    <label class="layui-form-label">开始日期</label>
                                                    <div class="layui-input-inline">
                                                       <input type="text" class="layui-input" id="startDate" name="startDate" placeholder="yyyy-MM-dd HH:mm:ss">
                                                    </div>
                                                </div>


                                                <div class="layui-inline">
                                                    <label class="layui-form-label">结束日期</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" class="layui-input" id="endDate" name="endDate" placeholder="yyyy-MM-dd HH:mm:ss">
                                                    </div>
                                                </div>
                            <div class="layui-inline">&emsp;

                                                        <button class="layui-btn icon-btn currSerachBtn" lay-filter="userTbSearch" lay-submit >
                                                            <i class="layui-icon">&#xe615;</i>搜索
                                                        </button>
                                <button class="layui-btn icon-btn currReloadBtn" lay-filter="reloadData" lay-submit style="background-color: #926dde;border-color: #926dde;">
                                    <i class="layui-icon layui-icon-refresh"></i>刷新数据
                                </button>
                            </div>
                        </div>
                    </form>
                    <!-- 数据表格 -->
                    <table id="userTable" lay-filter="userTable" style="margin-top:10px"></table>

                </div>
            </div>
        </div>
    </div>
</div>


<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=318"></script>
<script src="../../assets/libs/echarts/echarts.min.js"></script>
<script src="../../assets/libs/echarts/china.js"></script>
<script src="../../assets/libs/echarts/echarts-wordcloud.min.js"></script>
<!--    引入组件主题-->
<script src="../../assets/js/echartthemes.js"></script>
<script type="text/javascript" src="../../assets/js/jquery.min.js"></script>
<script type="text/javascript" src="../../assets/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../../assets/js/config.url.js"></script>

<script>
    var mybck = $.cookie('tokenMyb_mer');
    //alert(document.cookie);
    //console.log(mybck)
    if (mybck == "" || mybck == null) {

        window.top.location.href = "../../login.html";

    } else {

        var jsondata ;
        var bankListArr = []

        var currDateVal
        var currDateVal_end
        var local_storage_key = 'pay_console_list_t_list';
        layui.use(['layer', 'form', 'table', 'util', 'admin', 'xmSelect','notice','treeTable','laydate'], function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            var form = layui.form;
            var table = layui.table;
            var util = layui.util;
            var admin = layui.admin;
            var xmSelect = layui.xmSelect;
            var notice = layui.notice;
            var treeTable = layui.treeTable
            var laydate = layui.laydate;


            //开始日期组件常规用法
            laydate.render({
                elem: '#startDate'
                ,isInitValue: true
                ,theme: 'molv'
                ,type: 'datetime'
                ,done: function(value, date){//选中后的回调
                    // layer.alert('你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                    // console.log("自带的",date)
                    // console.log("jquery",$("#buildDate").val())
                    currDateVal = ""
                    currDateVal = value
                }
            });


            //结束日期组件常规用法
            laydate.render({
                elem: '#endDate'
                ,isInitValue: true
                ,theme: 'molv'
                ,type: 'datetime'
                ,done: function(value, date){//选中后的回调
                    // layer.alert('你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                    // console.log("自带的",date)
                    // console.log("jquery",$("#buildDate").val())
                    currDateVal_end = ""
                    currDateVal_end = value
                }
            });


            //获取数据添加到下拉框中
            var param = {};
            // param.page = 1
            // param.limit = 3000

            $.ajax({
                url: global_requestAddress + global_requestAddress_js_statistics + "?action=all",
                headers: {
                    "token": mybck
                },
                dataType: 'json',
                type: 'post',
                data: param,
                success: function (res) {
                    if (res.code === 200) {
                        var returnDataArray = res.result
                        $("#TodayCollection").text(returnDataArray.TodayCollection)
                        $("#TodayCollectionAmount").text(returnDataArray.TodayCollectionAmount)
                        $("#TodayCollectionCommission").text(returnDataArray.TodayCollectionCommission)
                        $("#TodayPay").text(returnDataArray.TodayPay)
                        $("#TodayPayCommission").text(returnDataArray.TodayPayCommission)
                        $("#TodayPayAmount").text(returnDataArray.TodayPayAmount)
                        $("#AllAmount").text(returnDataArray.AllAmount)
                        $("#AvailableAmount").text(returnDataArray.AvailableAmount)
                        $("#FreezeAmount").text(returnDataArray.FreezeAmount)
                    }
                }
            })



            var log_login_request_param = {};
            // log_login_request_param['kinds']= 1;
            // log_login_request_param['token']= $.cookie('tokenMyb');
            /* 渲染表格 */
            var tableCols = tableSetCol(getTableCols(), local_storage_key);
            var insTb = table.render({
                elem: '#userTable',
                url: global_requestAddress + global_requestAddress_js_statistics + "?action=list" ,
                method: 'post',
                headers:{
                    token:mybck
                },
                response: {
                    statusCode: 200,
                    dataName: 'result',
                },
                // toolbar: true,
                // defaultToolbar: ['filter'],
                // where:log_login_request_param,
                // toolbar: ['<p>',
                //     '<button lay-event="add" class="layui-btn layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>&nbsp;',
                //     '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>删除</button>',
                //     '</p>'].join(''),
                cellMinWidth: 100,
                page :  { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                    //,curr: 5 //设定初始在第 5 页
                    ,groups: 10 //只显示 1 个连续页码
                    ,first: "首页" //不显示首页
                    ,last: "尾页"//不显示尾页
                },
                height : "full-150",
                limit : 20,
                limits : [20,30,50,100],
                // id : "systemLog",
                cols:tableCols,
                done: function (res, curr, count) {
                    $('tr').css({'background-color': '#fff', 'color': '#191a1c'});

                    tableDone(this.elem, insTb.config.cols[0], local_storage_key)

                    //重新渲染 固定写法
                    form.render("select");
                    // $(".layui-table-main tr").each(function (index, val) {
                    //     $($(".layui-table-fixed-l .layui-table-body tbody tr")[index]).height($(val).height());
                    //     $($(".layui-table-fixed-r .layui-table-body tbody tr")[index]).height($(val).height());
                    // });

                }
            });


            //layui表格渲染后，事件需要重新绑定，并记录下筛选信息于localStorage
            function tableDone(elem, col, key){
                elem.next().find('[lay-event="LAYTABLE_COLS"]').click(function(e) {
                    setTimeout(function() {
                        layui.$(e.currentTarget).find('.layui-form-checkbox').click(function() {
                            var local_config = {};
                            for(var i = 0; i<=col.length-1; i++){
                                if(typeof col[i].field !== 'undefined'){
                                    local_config[col[i].field] = col[i].hide ;
                                }
                            }
                            var saveColsConfig = {
                                key: 'local_config',
                                value: local_config
                            };

                            // console.log("saveColsConfig",saveColsConfig)
                            layui.data(key, saveColsConfig);
                        })
                    }, 50);
                })
            }

            //表格 头部数据函数封装
            function getTableCols() {
                var col = [[
                    // {type: 'checkbox'},
                    // {field: 'ID',title:'ID',sort: true,align:"center",width:70},
                    {field: 'Date', title: '日期', sort: true,align:"center"},
                    {field: 'MerchantNum', title: '商户号',  sort: true,align:"center"},
                    {field: 'TodayCollection', title: '代收笔数', sort: true,align:"center",width:180},
                    {field: 'TodayCollectionAmount', title: '代收金额', sort: true,align:"center",width:120},
                    {field: 'TodayCollectionCommission', title: '代收手续费',  sort: true,align:"center",width:130},
                    {field: 'TodayPay', title: '代付笔数', sort: true,align:"center"},
                    {field: 'TodayPayCommission', title: '代付金额', sort: true,align:"center"},
                    {field: 'TodayPayAmount', title: '代付手续费', sort: true,align:"center"},

                    // {field: 'Created', title: '创建时间',align:"center",width:175, sort: true, templet: function (d) {
                    //         // return util.toDateString(d.Created* 1000);
                    //         return moment(d.Created * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');
                    //     }},
                    // {
                    //     field: 'Updated', title: '更新时间',align:"center",width:175, templet: function (d) {
                    //         // return util.toDateString(d.Updated* 1000);
                    //         return moment(d.Updated * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');
                    //     }, sort: true
                    // },
                    // {title: '操作', width:180, templet:'#orderListBar',fixed:"right",align:"center"}
                ]]
                return col;
            }

            //layuitable reload或第一次加载的时候，根据存储的local_config 确定哪些列是否选中
            function tableSetCol(col, key){
                let colArr = col[0]
                var config_custom= layui.data(key);
                var local_config = config_custom['local_config'] || {};
                if(JSON.stringify(local_config) != '{}'){
                    for(var i =0; i<=colArr.length-1; i++){
                        if( typeof colArr[i].field !== "undefined" ){
                            colArr[i].hide = local_config[colArr[i].field];
                        }
                    }
                }
                return [colArr];
            }


            /* 表格搜索 */
            var currTempObj;
            var bet_tb_this;
            form.on('submit(userTbSearch)', function (data) {

                // console.log("currTempObj",data.field.username)
                // insTb.reload({where: data.field, page: {curr: 1}});
                currTempObj = {}

                var todayStartTime = new Date(new Date().toLocaleDateString()).getTime()/1000 + 1
                var todayEndTime = new Date(new Date().toLocaleDateString()).getTime()/1000 + 24 * 60 * 60  - 1

                if(data.field.startDate == '' && data.field.endDate == '' ){

                    // currTempObj.start = todayStartTime
                    // currTempObj.end = todayEndTime

                }else if(data.field.startDate != '' && data.field.endDate != '' ){

                    var date_str_start = new Date(data.field.startDate)
                    currTempObj.start = Date.parse(date_str_start) / 1000

                    var date_str_end = new Date(data.field.endDate)
                    currTempObj.end = Date.parse(date_str_end) / 1000

                }else{

                    if(data.field.startDate == "" && data.field.endDate != ""){

                        currTempObj.start = 0
                        var date_str_end = new Date(data.field.endDate)
                        currTempObj.end = Date.parse(date_str_end) / 1000

                    }else if(data.field.startDate != "" && data.field.endDate == ""){

                        var date_str_start = new Date(data.field.startDate)
                        currTempObj.start = Date.parse(date_str_start) / 1000
                        currTempObj.end = todayEndTime
                    }


                }


                //2.6.0之前清除保留之前的数据的最有用的方式
                if (bet_tb_this != null) {
                    // console.log("book_tb_this--不为null",bet_tb_this)
                    bet_tb_this.where = {};  //置空where
                }
                insTb.reload({
                    where: currTempObj,
                    page: {curr: 1},
                    done:function(){
                        bet_tb_this = this;
                        // console.log("book_tb_this----重载后的值",bet_tb_this)
                    }
                },false);


                return false;
            });


            /* 表格工具条点击事件 */
            table.on('tool(userTable)', function (obj) {
                var currDatas  = obj.data;
                if (obj.event === 'xxxx') { // 修改
                    // showEditModel(obj.data);

                    layer.confirm('xxxx？', {
                        skin: 'layui-layer-admin',
                        shade: .1
                    }, function (i) {
                        layer.close(i);
                        var loadIndex = layer.load(2);

                        var param = {};
                        param['id'] = currDatas.ID;

                        $.ajax({
                            url: global_requestAddress,
                            data: param,
                            headers:{
                                token:mybck
                            },
                            type: "POST",
                            dataType: "json",
                            success: function (addResult) {
                                layer.close(loadIndex);
                                if (addResult.code === 200) {
                                    notice.msg(addResult.msg, {icon: 1});
                                    insTb.reload({page: {curr: 1}});
                                } else {
                                    notice.msg(addResult.msg, {icon: 2});
                                }

                            },


                        });

                    });


                }else if(obj.event === 'deleteBtn'){ //删除

                    // jsondata = JSON.stringify(currDatas)
                    // var index = layui.layer.open({
                    //     area: ['1200px', '500px'],
                    //     fixed: false, //不固定
                    //     maxmin: false,
                    //     title : "xxx",
                    //     skin: 'layui-layer-rim',//加上边框
                    //     type : 2,
                    //     content : "bank_lists.html",
                    //     success : function(layero, index){
                    //         var body = layui.layer.getChildFrame('body', index);
                    //         if(currDatas) {
                    //
                    //         }
                    //     },
                    //     end : function() {//弹窗关闭后的回调函数
                    //         //利用laypage实现局部刷新,以下两种方式都可以
                    //         // $(".layui-laypage-btn").click()
                    //         //直接刷新当前修改的行
                    //         $(".layui-laypage-btn")[0].click()
                    //
                    //     }
                    // })
                    // window.sessionStorage.setItem("index",index);
                    // //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    // $(window).on("resize",function(){
                    //     layui.layer.full(window.sessionStorage.getItem("index"));
                    // })

                }
            });




        });


    }
</script>
</body>
</html>
